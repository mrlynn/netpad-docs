"use strict";(self.webpackChunkdocs_netpad_io=self.webpackChunkdocs_netpad_io||[]).push([[1709],{11908:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>l,contentTitle:()=>a,default:()=>x,frontMatter:()=>o,metadata:()=>t,toc:()=>d});const t=JSON.parse('{"id":"extensions/architecture","title":"Extension Architecture","description":"Deep dive into NetPad\'s extension system internals","source":"@site/docs/extensions/architecture.md","sourceDirName":"extensions","slug":"/extensions/architecture","permalink":"/docs/extensions/architecture","draft":false,"unlisted":false,"editUrl":"https://github.com/mrlynn/netpad-v3/tree/main/docs/docs/extensions/architecture.md","tags":[],"version":"current","sidebarPosition":2,"frontMatter":{"sidebar_position":2,"title":"Extension Architecture","description":"Deep dive into NetPad\'s extension system internals"},"sidebar":"docs","previous":{"title":"\ud83d\udcd6 Overview","permalink":"/docs/extensions/overview"},"next":{"title":"\ud83d\udd28 Building Extensions","permalink":"/docs/extensions/building-extensions"}}');var s=i(74848),r=i(28453);const o={sidebar_position:2,title:"Extension Architecture",description:"Deep dive into NetPad's extension system internals"},a="Extension Architecture",l={},d=[{value:"System Overview",id:"system-overview",level:2},{value:"Core Components",id:"core-components",level:2},{value:"Extension Loader (<code>src/lib/extensions/loader.ts</code>)",id:"extension-loader-srclibextensionsloaderts",level:3},{value:"Extension Registry (<code>src/lib/extensions/registry.ts</code>)",id:"extension-registry-srclibextensionsregistryts",level:3},{value:"Extension Types (<code>src/lib/extensions/types.ts</code>)",id:"extension-types-srclibextensionstypests",level:3},{value:"Extension Lifecycle",id:"extension-lifecycle",level:2},{value:"1. Discovery Phase",id:"1-discovery-phase",level:3},{value:"2. Loading Phase",id:"2-loading-phase",level:3},{value:"3. Registration Phase",id:"3-registration-phase",level:3},{value:"4. Initialization Phase",id:"4-initialization-phase",level:3},{value:"5. Runtime Phase",id:"5-runtime-phase",level:3},{value:"6. Cleanup Phase",id:"6-cleanup-phase",level:3},{value:"Route Handling",id:"route-handling",level:2},{value:"Feature Flag System",id:"feature-flag-system",level:2},{value:"Using Features in Code",id:"using-features-in-code",level:3},{value:"Service Architecture",id:"service-architecture",level:2},{value:"Middleware System",id:"middleware-system",level:2},{value:"Error Handling",id:"error-handling",level:2},{value:"Testing Extensions",id:"testing-extensions",level:2},{value:"Next Steps",id:"next-steps",level:2}];function c(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",ol:"ol",p:"p",pre:"pre",strong:"strong",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,r.R)(),...e.components};return(0,s.jsxs)(s.Fragment,{children:[(0,s.jsx)(n.header,{children:(0,s.jsx)(n.h1,{id:"extension-architecture",children:"Extension Architecture"})}),"\n",(0,s.jsx)(n.p,{children:"This guide explains the internal architecture of NetPad's extension system, including how extensions are loaded, registered, and integrated with the core application."}),"\n",(0,s.jsx)(n.h2,{id:"system-overview",children:"System Overview"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"\u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510\n\u2502                           NetPad Application                            \u2502\n\u251c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2524\n\u2502                                                                         \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502\n\u2502  \u2502   Extension     \u2502    \u2502    Extension    \u2502    \u2502    Extension    \u2502     \u2502\n\u2502  \u2502     Loader      \u2502\u2500\u2500\u2500\u25b6\u2502     Registry    \u2502\u2500\u2500\u2500\u25b6\u2502    Services     \u2502     \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502\n\u2502          \u2502                      \u2502                      \u2502                \u2502\n\u2502          \u25bc                      \u25bc                      \u25bc                \u2502\n\u2502  \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510    \u250c\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2510     \u2502\n\u2502  \u2502   Environment   \u2502    \u2502  Feature Flags  \u2502    \u2502  Route Handler  \u2502     \u2502\n\u2502  \u2502   Detection     \u2502    \u2502                 \u2502    \u2502                 \u2502     \u2502\n\u2502  \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518    \u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518     \u2502\n\u2502                                                                         \u2502\n\u2514\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2500\u2518\n"})}),"\n",(0,s.jsx)(n.h2,{id:"core-components",children:"Core Components"}),"\n",(0,s.jsxs)(n.h3,{id:"extension-loader-srclibextensionsloaderts",children:["Extension Loader (",(0,s.jsx)(n.code,{children:"src/lib/extensions/loader.ts"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"The loader is responsible for discovering and importing extension packages."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Loading process\nasync function loadExtensions(): Promise<void> {\n  // 1. Load cloud extension if in cloud mode\n  const cloudExtension = await loadCloudExtension();\n  if (cloudExtension) registerExtension(cloudExtension);\n\n  // 2. Load plugin extensions from NETPAD_EXTENSIONS\n  const pluginExtensions = await loadPluginExtensions();\n  for (const extension of pluginExtensions) {\n    registerExtension(extension);\n  }\n\n  // 3. Initialize all registered extensions\n  await initializeExtensions();\n}\n"})}),"\n",(0,s.jsx)(n.p,{children:(0,s.jsx)(n.strong,{children:"Key functions:"})}),"\n",(0,s.jsxs)(n.table,{children:[(0,s.jsx)(n.thead,{children:(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.th,{children:"Function"}),(0,s.jsx)(n.th,{children:"Description"})]})}),(0,s.jsxs)(n.tbody,{children:[(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"loadExtensions()"})}),(0,s.jsx)(n.td,{children:"Main entry point, loads all extensions"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"loadExtensionPackage(name)"})}),(0,s.jsx)(n.td,{children:"Dynamically imports an extension package"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"extensionsLoaded()"})}),(0,s.jsx)(n.td,{children:"Returns true if extensions have been loaded"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"waitForExtensions()"})}),(0,s.jsx)(n.td,{children:"Awaits extension loading completion"})]}),(0,s.jsxs)(n.tr,{children:[(0,s.jsx)(n.td,{children:(0,s.jsx)(n.code,{children:"resetLoader()"})}),(0,s.jsx)(n.td,{children:"Resets loader state (for testing)"})]})]})]}),"\n",(0,s.jsxs)(n.h3,{id:"extension-registry-srclibextensionsregistryts",children:["Extension Registry (",(0,s.jsx)(n.code,{children:"src/lib/extensions/registry.ts"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"The registry maintains the state of all loaded extensions and provides access to their capabilities."}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Registry state\ninterface ExtensionRegistryState {\n  extensions: Map<string, NetPadExtension>;\n  features: Set<ExtensionFeature>;\n  initialized: boolean;\n}\n\n// Key operations\nregisterExtension(extension: NetPadExtension): void\ninitializeExtensions(): Promise<void>\ngetExtension(id: string): NetPadExtension | undefined\nisFeatureAvailable(feature: ExtensionFeature): boolean\ngetExtensionRoutes(): ExtensionRoute[]\ngetExtensionMiddleware(): ExtensionMiddleware[]\ngetService<T>(extensionId: string, serviceName: string): T | undefined\n"})}),"\n",(0,s.jsxs)(n.h3,{id:"extension-types-srclibextensionstypests",children:["Extension Types (",(0,s.jsx)(n.code,{children:"src/lib/extensions/types.ts"}),")"]}),"\n",(0,s.jsx)(n.p,{children:"Core type definitions for the extension system:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"/**\n * Main extension interface - all extensions must implement this\n */\nexport interface NetPadExtension {\n  metadata: ExtensionMetadata;\n  features: ExtensionFeature[];\n  routes?: ExtensionRoute[];\n  middleware?: ExtensionMiddleware[];\n  services?: Record<string, unknown>;\n  components?: Record<string, React.ComponentType>;\n  initialize?: () => Promise<void>;\n  cleanup?: () => Promise<void>;\n}\n\n/**\n * Extension metadata\n */\nexport interface ExtensionMetadata {\n  id: string;           // Unique identifier\n  name: string;         // Display name\n  version: string;      // Semantic version\n  description?: string; // Human-readable description\n  author?: string;      // Package author\n  homepage?: string;    // Documentation URL\n}\n\n/**\n * API route definition\n */\nexport interface ExtensionRoute {\n  path: string;                                    // URL path\n  method: 'GET' | 'POST' | 'PUT' | 'DELETE' | 'PATCH';\n  handler: (req: NextRequest, ctx?: RouteContext) => Promise<NextResponse>;\n  middleware?: string[];  // Middleware IDs to apply\n}\n\n/**\n * Middleware definition\n */\nexport interface ExtensionMiddleware {\n  id?: string;          // Optional identifier\n  path: string;         // Path pattern to match\n  handler: MiddlewareHandler;\n  priority?: number;    // Execution order (lower = earlier)\n}\n\n/**\n * Feature flags\n */\nexport type ExtensionFeature =\n  | 'billing'\n  | 'stripe_integration'\n  | 'subscription_management'\n  | 'usage_tracking'\n  | 'atlas_provisioning'\n  | 'premium_support'\n  | 'advanced_analytics'\n  | 'sso_authentication'\n  | 'audit_logging'\n  | 'custom_branding'\n  | `custom:${string}`;  // Custom features use this prefix\n"})}),"\n",(0,s.jsx)(n.h2,{id:"extension-lifecycle",children:"Extension Lifecycle"}),"\n",(0,s.jsx)(n.h3,{id:"1-discovery-phase",children:"1. Discovery Phase"}),"\n",(0,s.jsx)(n.p,{children:"Extensions are discovered through:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Environment Variables"})," - ",(0,s.jsx)(n.code,{children:"NETPAD_EXTENSIONS"})," contains comma-separated package names"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Cloud Mode Detection"})," - ",(0,s.jsx)(n.code,{children:"NETPAD_CLOUD=true"})," triggers cloud extension loading"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Static Registration"})," - Known extensions are pre-registered in the loader"]}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Known extension loaders (enables webpack static analysis)\nconst knownExtensionLoaders: Record<string, () => Promise<unknown>> = {\n  '@netpad/cloud-features': () => import('@netpad/cloud-features').catch(() => null),\n  '@netpad/collaborate': () => import('@netpad/collaborate').catch(() => null),\n};\n"})}),"\n",(0,s.jsx)(n.h3,{id:"2-loading-phase",children:"2. Loading Phase"}),"\n",(0,s.jsx)(n.p,{children:"Each extension package is dynamically imported and validated:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"async function loadExtensionPackage(packageName: string): Promise<NetPadExtension | null> {\n  // Try known loaders first (for webpack compatibility)\n  if (knownExtensionLoaders[packageName]) {\n    const module = await knownExtensionLoaders[packageName]();\n    // Extract extension from module exports\n  }\n\n  // Look for default export or named exports\n  // - module.default\n  // - module.extension\n  // - module.{packageName}Extension\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"3-registration-phase",children:"3. Registration Phase"}),"\n",(0,s.jsx)(n.p,{children:"Extensions are registered in the global registry:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"function registerExtension(extension: NetPadExtension): void {\n  // Add to extensions map\n  state.extensions.set(extension.metadata.id, extension);\n\n  // Register features\n  for (const feature of extension.features) {\n    state.features.add(feature);\n  }\n\n  console.log(`[Extensions] Registered: ${extension.metadata.name} v${extension.metadata.version}`);\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"4-initialization-phase",children:"4. Initialization Phase"}),"\n",(0,s.jsxs)(n.p,{children:["Each extension's ",(0,s.jsx)(n.code,{children:"initialize()"})," hook is called:"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"async function initializeExtensions(): Promise<void> {\n  for (const [id, extension] of state.extensions) {\n    if (extension.initialize) {\n      await extension.initialize();\n      console.log(`[Extensions] Initialized: ${id}`);\n    }\n  }\n  state.initialized = true;\n}\n"})}),"\n",(0,s.jsx)(n.h3,{id:"5-runtime-phase",children:"5. Runtime Phase"}),"\n",(0,s.jsx)(n.p,{children:"During runtime, the application accesses extension capabilities:"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Routes"})," are matched via the catch-all handler at ",(0,s.jsx)(n.code,{children:"/api/ext/[...path]"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Features"})," are checked via ",(0,s.jsx)(n.code,{children:"isFeatureAvailable()"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Services"})," are accessed via ",(0,s.jsx)(n.code,{children:"getService()"})]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.strong,{children:"Middleware"})," is applied based on path matching"]}),"\n"]}),"\n",(0,s.jsx)(n.h3,{id:"6-cleanup-phase",children:"6. Cleanup Phase"}),"\n",(0,s.jsx)(n.p,{children:"When the application shuts down or during hot reload:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"async function cleanupExtensions(): Promise<void> {\n  for (const [id, extension] of state.extensions) {\n    if (extension.cleanup) {\n      await extension.cleanup();\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"route-handling",children:"Route Handling"}),"\n",(0,s.jsx)(n.p,{children:"Extension routes are handled by a catch-all Next.js route:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{children:"src/app/api/ext/[...path]/route.ts\n"})}),"\n",(0,s.jsx)(n.p,{children:"This handler:"}),"\n",(0,s.jsxs)(n.ol,{children:["\n",(0,s.jsx)(n.li,{children:"Loads extensions if not already loaded"}),"\n",(0,s.jsx)(n.li,{children:"Extracts the path from the URL"}),"\n",(0,s.jsx)(n.li,{children:"Matches against registered routes"}),"\n",(0,s.jsx)(n.li,{children:"Applies any associated middleware"}),"\n",(0,s.jsx)(n.li,{children:"Invokes the route handler"}),"\n"]}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Route matching\nasync function handleExtensionRoute(\n  request: NextRequest,\n  method: HttpMethod,\n  pathParts: string[]\n): Promise<NextResponse> {\n  // Ensure extensions are loaded\n  if (!extensionsLoaded()) {\n    await loadExtensions();\n  }\n\n  // Build full path\n  const fullPath = `/api/ext/${pathParts.join('/')}`;\n\n  // Find matching route\n  const routes = getExtensionRoutes();\n  const matchingRoute = routes.find(\n    route => route.method === method && route.path === fullPath\n  );\n\n  if (!matchingRoute) {\n    return NextResponse.json(\n      { error: 'Extension route not found', path: fullPath, method },\n      { status: 404 }\n    );\n  }\n\n  // Execute handler\n  return await matchingRoute.handler(request, { params: { path: pathParts } });\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"feature-flag-system",children:"Feature Flag System"}),"\n",(0,s.jsx)(n.p,{children:"Features allow conditional functionality based on which extensions are loaded:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:'// Check feature availability\nfunction isFeatureAvailable(feature: ExtensionFeature): boolean {\n  return state.features.has(feature);\n}\n\n// Get feature availability details\nfunction getFeatureAvailability(feature: ExtensionFeature): {\n  available: boolean;\n  provider?: string;\n  message?: string;\n} {\n  if (!state.features.has(feature)) {\n    return {\n      available: false,\n      message: `Feature "${feature}" requires an extension that is not installed`,\n    };\n  }\n\n  // Find which extension provides this feature\n  for (const [id, extension] of state.extensions) {\n    if (extension.features.includes(feature)) {\n      return {\n        available: true,\n        provider: extension.metadata.name,\n      };\n    }\n  }\n\n  return { available: true };\n}\n'})}),"\n",(0,s.jsx)(n.h3,{id:"using-features-in-code",children:"Using Features in Code"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// In API routes\nimport { isFeatureAvailable } from '@/lib/extensions/registry';\n\nexport async function POST(request: NextRequest) {\n  if (!isFeatureAvailable('billing')) {\n    return NextResponse.json(\n      { error: 'Billing features are not available in this deployment' },\n      { status: 400 }\n    );\n  }\n\n  // Process billing request...\n}\n\n// In React components\nfunction BillingSection() {\n  const billingAvailable = isFeatureAvailable('billing');\n\n  if (!billingAvailable) {\n    return <SelfHostedBillingMessage />;\n  }\n\n  return <BillingDashboard />;\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"service-architecture",children:"Service Architecture"}),"\n",(0,s.jsx)(n.p,{children:"Extensions can expose services for shared functionality:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Define a service\ninterface MyService {\n  doSomething(): Promise<void>;\n  getSomething(): Promise<Data>;\n}\n\n// Register in extension\nconst myExtension: NetPadExtension = {\n  // ...\n  services: {\n    myService: myServiceImplementation,\n  },\n};\n\n// Access from other code\nimport { getService } from '@/lib/extensions/registry';\n\nconst myService = getService<MyService>('my-extension', 'myService');\nif (myService) {\n  await myService.doSomething();\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"middleware-system",children:"Middleware System"}),"\n",(0,s.jsx)(n.p,{children:"Extensions can provide middleware that processes requests:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Define middleware\nconst authMiddleware: ExtensionMiddleware = {\n  id: 'my-extension:auth',\n  path: '/api/ext/my-extension/*',\n  priority: 10,  // Lower = runs earlier\n  handler: async (request, next) => {\n    // Verify authentication\n    const token = request.headers.get('authorization');\n    if (!token) {\n      return NextResponse.json({ error: 'Unauthorized' }, { status: 401 });\n    }\n\n    // Continue to next middleware or route handler\n    return next(request);\n  },\n};\n"})}),"\n",(0,s.jsx)(n.p,{children:"Middleware is executed in priority order:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"function getExtensionMiddleware(): ExtensionMiddleware[] {\n  const allMiddleware: ExtensionMiddleware[] = [];\n\n  for (const extension of state.extensions.values()) {\n    if (extension.middleware) {\n      allMiddleware.push(...extension.middleware);\n    }\n  }\n\n  // Sort by priority (lower first)\n  return allMiddleware.sort((a, b) => (a.priority ?? 100) - (b.priority ?? 100));\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"error-handling",children:"Error Handling"}),"\n",(0,s.jsx)(n.p,{children:"Extensions are designed to fail gracefully:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"// Extension loading errors are caught\nasync function loadExtensionPackage(packageName: string) {\n  try {\n    // Attempt to load\n  } catch (error) {\n    // Log but don't crash\n    console.error(`[Extensions] Error loading ${packageName}:`, error);\n    return null;\n  }\n}\n\n// Initialization errors are isolated\nasync function initializeExtensions() {\n  for (const [id, extension] of state.extensions) {\n    try {\n      await extension.initialize?.();\n    } catch (error) {\n      console.error(`[Extensions] Failed to initialize ${id}:`, error);\n      // Continue with other extensions\n    }\n  }\n}\n"})}),"\n",(0,s.jsx)(n.h2,{id:"testing-extensions",children:"Testing Extensions"}),"\n",(0,s.jsx)(n.p,{children:"The extension system provides testing utilities:"}),"\n",(0,s.jsx)(n.pre,{children:(0,s.jsx)(n.code,{className:"language-typescript",children:"import { resetRegistry } from '@/lib/extensions/registry';\nimport { resetLoader } from '@/lib/extensions/loader';\n\ndescribe('My Extension', () => {\n  beforeEach(() => {\n    resetRegistry();\n    resetLoader();\n  });\n\n  it('should register correctly', () => {\n    registerExtension(myExtension);\n    expect(getExtension('my-extension')).toBeDefined();\n  });\n\n  it('should provide features', () => {\n    registerExtension(myExtension);\n    expect(isFeatureAvailable('custom:my_feature')).toBe(true);\n  });\n});\n"})}),"\n",(0,s.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,s.jsxs)(n.ul,{children:["\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./building-extensions",children:"Building Extensions"})," - Create your own extension"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./api-reference",children:"API Reference"})," - Complete API documentation"]}),"\n",(0,s.jsxs)(n.li,{children:[(0,s.jsx)(n.a,{href:"./example-collaborate",children:"Example: Collaborate Extension"})," - Real-world walkthrough"]}),"\n"]})]})}function x(e={}){const{wrapper:n}={...(0,r.R)(),...e.components};return n?(0,s.jsx)(n,{...e,children:(0,s.jsx)(c,{...e})}):c(e)}},28453:(e,n,i)=>{i.d(n,{R:()=>o,x:()=>a});var t=i(96540);const s={},r=t.createContext(s);function o(e){const n=t.useContext(r);return t.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function a(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(s):e.components||s:o(e.components),t.createElement(r.Provider,{value:n},e.children)}}}]);