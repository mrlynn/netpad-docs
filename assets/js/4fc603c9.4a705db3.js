"use strict";(self.webpackChunkdocs_netpad_io=self.webpackChunkdocs_netpad_io||[]).push([[3553],{8453:(e,n,i)=>{i.d(n,{R:()=>d,x:()=>t});var l=i(6540);const r={},s=l.createContext(r);function d(e){const n=l.useContext(s);return l.useMemo((function(){return"function"==typeof e?e(n):{...n,...e}}),[n,e])}function t(e){let n;return n=e.disableParentContext?"function"==typeof e.components?e.components(r):e.components||r:d(e.components),l.createElement(s.Provider,{value:n},e.children)}},9048:(e,n,i)=>{i.r(n),i.d(n,{assets:()=>c,contentTitle:()=>t,default:()=>h,frontMatter:()=>d,metadata:()=>l,toc:()=>a});const l=JSON.parse('{"id":"pipeline-builder/aggregation-stages","title":"Aggregation Stages","description":"Learn about the available aggregation stages and how to use them to transform your data.","source":"@site/docs/pipeline-builder/aggregation-stages.md","sourceDirName":"pipeline-builder","slug":"/pipeline-builder/aggregation-stages","permalink":"/docs/pipeline-builder/aggregation-stages","draft":false,"unlisted":false,"editUrl":"https://github.com/mrlynn/netpad-v3/tree/main/docs/docs/pipeline-builder/aggregation-stages.md","tags":[],"version":"current","frontMatter":{},"sidebar":"docs","previous":{"title":"Pipeline Builder","permalink":"/docs/pipeline-builder/overview"},"next":{"title":"AI Pipeline Generation","permalink":"/docs/pipeline-builder/ai-pipeline-generation"}}');var r=i(4848),s=i(8453);const d={},t="Aggregation Stages",c={},a=[{value:"Common Stages",id:"common-stages",level:2},{value:"$match",id:"match",level:3},{value:"$project",id:"project",level:3},{value:"$group",id:"group",level:3},{value:"$sort",id:"sort",level:3},{value:"$limit",id:"limit",level:3},{value:"$skip",id:"skip",level:3},{value:"$lookup",id:"lookup",level:3},{value:"$unwind",id:"unwind",level:3},{value:"Advanced Stages",id:"advanced-stages",level:2},{value:"$addFields",id:"addfields",level:3},{value:"$bucket",id:"bucket",level:3},{value:"$facet",id:"facet",level:3},{value:"$graphLookup",id:"graphlookup",level:3},{value:"$merge",id:"merge",level:3},{value:"$out",id:"out",level:3},{value:"Aggregation Operators",id:"aggregation-operators",level:2},{value:"Arithmetic",id:"arithmetic",level:3},{value:"String",id:"string",level:3},{value:"Array",id:"array",level:3},{value:"Date",id:"date",level:3},{value:"Conditional",id:"conditional",level:3},{value:"Example Pipeline",id:"example-pipeline",level:2},{value:"Stage Selection Tips",id:"stage-selection-tips",level:2},{value:"Next Steps",id:"next-steps",level:2}];function o(e){const n={a:"a",code:"code",h1:"h1",h2:"h2",h3:"h3",header:"header",li:"li",p:"p",pre:"pre",table:"table",tbody:"tbody",td:"td",th:"th",thead:"thead",tr:"tr",ul:"ul",...(0,s.R)(),...e.components};return(0,r.jsxs)(r.Fragment,{children:[(0,r.jsx)(n.header,{children:(0,r.jsx)(n.h1,{id:"aggregation-stages",children:"Aggregation Stages"})}),"\n",(0,r.jsx)(n.p,{children:"Learn about the available aggregation stages and how to use them to transform your data."}),"\n",(0,r.jsx)(n.h2,{id:"common-stages",children:"Common Stages"}),"\n",(0,r.jsx)(n.h3,{id:"match",children:"$match"}),"\n",(0,r.jsx)(n.p,{children:"Filter documents by conditions:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'{\n  $match: {\n    status: "active",\n    age: { $gte: 18 }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Use early in pipeline to reduce documents processed."}),"\n",(0,r.jsx)(n.h3,{id:"project",children:"$project"}),"\n",(0,r.jsx)(n.p,{children:"Select or transform fields:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'{\n  $project: {\n    name: 1,\n    email: 1,\n    fullName: { $concat: ["$firstName", " ", "$lastName"] },\n    _id: 0\n  }\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Include fields (1), exclude fields (0), or create computed fields."}),"\n",(0,r.jsx)(n.h3,{id:"group",children:"$group"}),"\n",(0,r.jsx)(n.p,{children:"Group documents and calculate aggregates:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'{\n  $group: {\n    _id: "$category",\n    count: { $sum: 1 },\n    avgPrice: { $avg: "$price" },\n    totalRevenue: { $sum: "$amount" }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"sort",children:"$sort"}),"\n",(0,r.jsx)(n.p,{children:"Order documents by field values:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  $sort: {\n    createdAt: -1,  // descending\n    name: 1         // ascending\n  }\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"limit",children:"$limit"}),"\n",(0,r.jsx)(n.p,{children:"Restrict number of documents:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  $limit: 10\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"skip",children:"$skip"}),"\n",(0,r.jsx)(n.p,{children:"Skip first N documents (for pagination):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:"{\n  $skip: 20\n}\n"})}),"\n",(0,r.jsx)(n.h3,{id:"lookup",children:"$lookup"}),"\n",(0,r.jsx)(n.p,{children:"Join with another collection:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'{\n  $lookup: {\n    from: "orders",\n    localField: "_id",\n    foreignField: "customerId",\n    as: "orders"\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"unwind",children:"$unwind"}),"\n",(0,r.jsx)(n.p,{children:"Flatten arrays into documents:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'{\n  $unwind: "$tags"\n}\n'})}),"\n",(0,r.jsx)(n.p,{children:"Each array element becomes a separate document."}),"\n",(0,r.jsx)(n.h2,{id:"advanced-stages",children:"Advanced Stages"}),"\n",(0,r.jsx)(n.h3,{id:"addfields",children:"$addFields"}),"\n",(0,r.jsx)(n.p,{children:"Add new calculated fields:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'{\n  $addFields: {\n    total: { $multiply: ["$price", "$quantity"] },\n    discountedPrice: { $subtract: ["$price", "$discount"] }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"bucket",children:"$bucket"}),"\n",(0,r.jsx)(n.p,{children:"Group into ranges:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'{\n  $bucket: {\n    groupBy: "$age",\n    boundaries: [0, 18, 30, 50, 100],\n    default: "Other",\n    output: {\n      count: { $sum: 1 }\n    }\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"facet",children:"$facet"}),"\n",(0,r.jsx)(n.p,{children:"Multiple parallel pipelines:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'{\n  $facet: {\n    "byCategory": [\n      { $group: { _id: "$category", count: { $sum: 1 } } }\n    ],\n    "byStatus": [\n      { $group: { _id: "$status", count: { $sum: 1 } } }\n    ],\n    "total": [\n      { $count: "count" }\n    ]\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"graphlookup",children:"$graphLookup"}),"\n",(0,r.jsx)(n.p,{children:"Recursive lookups (for hierarchies):"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'{\n  $graphLookup: {\n    from: "employees",\n    startWith: "$managerId",\n    connectFromField: "managerId",\n    connectToField: "_id",\n    as: "reportingChain"\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"merge",children:"$merge"}),"\n",(0,r.jsx)(n.p,{children:"Write results to collection:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'{\n  $merge: {\n    into: "reports",\n    on: "_id",\n    whenMatched: "replace",\n    whenNotMatched: "insert"\n  }\n}\n'})}),"\n",(0,r.jsx)(n.h3,{id:"out",children:"$out"}),"\n",(0,r.jsx)(n.p,{children:"Output to new collection:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'{\n  $out: "aggregated_results"\n}\n'})}),"\n",(0,r.jsx)(n.h2,{id:"aggregation-operators",children:"Aggregation Operators"}),"\n",(0,r.jsx)(n.h3,{id:"arithmetic",children:"Arithmetic"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$add"})," - Add numbers"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$subtract"})," - Subtract"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$multiply"})," - Multiply"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$divide"})," - Divide"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$mod"})," - Modulo"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"string",children:"String"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$concat"})," - Concatenate strings"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$substr"})," - Substring"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$toLower"})," - Lowercase"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$toUpper"})," - Uppercase"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$trim"})," - Trim whitespace"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"array",children:"Array"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$arrayElemAt"})," - Get element by index"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$size"})," - Array length"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$filter"})," - Filter array"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$map"})," - Transform array"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$reduce"})," - Reduce array"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"date",children:"Date"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$year"}),", ",(0,r.jsx)(n.code,{children:"$month"}),", ",(0,r.jsx)(n.code,{children:"$dayOfMonth"})," - Extract date parts"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$dateToString"})," - Format date"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$dateFromString"})," - Parse date"]}),"\n"]}),"\n",(0,r.jsx)(n.h3,{id:"conditional",children:"Conditional"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$cond"})," - If-then-else"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$ifNull"})," - Null check"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.code,{children:"$switch"})," - Multiple conditions"]}),"\n"]}),"\n",(0,r.jsx)(n.h2,{id:"example-pipeline",children:"Example Pipeline"}),"\n",(0,r.jsx)(n.p,{children:"Group products by category and calculate statistics:"}),"\n",(0,r.jsx)(n.pre,{children:(0,r.jsx)(n.code,{className:"language-javascript",children:'[\n  // Filter active products\n  {\n    $match: {\n      status: "active"\n    }\n  },\n  // Group by category\n  {\n    $group: {\n      _id: "$category",\n      count: { $sum: 1 },\n      avgPrice: { $avg: "$price" },\n      minPrice: { $min: "$price" },\n      maxPrice: { $max: "$price" }\n    }\n  },\n  // Sort by count\n  {\n    $sort: {\n      count: -1\n    }\n  },\n  // Limit results\n  {\n    $limit: 10\n  }\n]\n'})}),"\n",(0,r.jsx)(n.h2,{id:"stage-selection-tips",children:"Stage Selection Tips"}),"\n",(0,r.jsxs)(n.table,{children:[(0,r.jsx)(n.thead,{children:(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.th,{children:"Need"}),(0,r.jsx)(n.th,{children:"Stage"})]})}),(0,r.jsxs)(n.tbody,{children:[(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Filter documents"}),(0,r.jsx)(n.td,{children:"$match"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Select/rename fields"}),(0,r.jsx)(n.td,{children:"$project"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Group and aggregate"}),(0,r.jsx)(n.td,{children:"$group"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Sort results"}),(0,r.jsx)(n.td,{children:"$sort"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Join collections"}),(0,r.jsx)(n.td,{children:"$lookup"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Flatten arrays"}),(0,r.jsx)(n.td,{children:"$unwind"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Add computed fields"}),(0,r.jsx)(n.td,{children:"$addFields"})]}),(0,r.jsxs)(n.tr,{children:[(0,r.jsx)(n.td,{children:"Multiple aggregations"}),(0,r.jsx)(n.td,{children:"$facet"})]})]})]}),"\n",(0,r.jsx)(n.h2,{id:"next-steps",children:"Next Steps"}),"\n",(0,r.jsxs)(n.ul,{children:["\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/pipeline-builder/overview",children:"Pipeline Builder"})," - Build pipelines visually"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/pipeline-builder/ai-pipeline-generation",children:"AI Pipeline Generation"})," - Generate with AI"]}),"\n",(0,r.jsxs)(n.li,{children:[(0,r.jsx)(n.a,{href:"/docs/pipeline-builder/results-viewer",children:"Results Viewer"})," - View pipeline output"]}),"\n"]})]})}function h(e={}){const{wrapper:n}={...(0,s.R)(),...e.components};return n?(0,r.jsx)(n,{...e,children:(0,r.jsx)(o,{...e})}):o(e)}}}]);